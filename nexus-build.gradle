// Nexus Repository ê´€ë ¨ ì¶”ê°€ íƒœìŠ¤í¬ë“¤

// ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ í™•ì¸ íƒœìŠ¤í¬
task checkDependencies {
    group = 'nexus'
    description = 'Nexus Repositoryì—ì„œ ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ìƒíƒœ í™•ì¸'
    
    doLast {
        configurations.compileClasspath.each { file ->
            println "Downloaded: ${file.name}"
        }
    }
}

// Nexus Repository ì—°ê²° í…ŒìŠ¤íŠ¸ íƒœìŠ¤í¬
task testNexusConnection {
    group = 'nexus'
    description = 'Nexus Repository ì—°ê²° í…ŒìŠ¤íŠ¸'
    
    doLast {
        repositories.each { repo ->
            if (repo.metaClass.hasProperty(repo, 'url')) {
                println "Testing connection to: ${repo.name} - ${repo.url}"
                try {
                    def connection = new URL(repo.url.toString()).openConnection()
                    connection.setConnectTimeout(5000)
                    connection.setReadTimeout(5000)
                    def responseCode = connection.getResponseCode()
                    println "âœ“ Connection successful: HTTP ${responseCode}"
                } catch (Exception e) {
                    println "âœ— Connection failed: ${e.message}"
                }
            }
        }
    }
}

// Boot Repository ì—°ê²° í…ŒìŠ¤íŠ¸ íƒœìŠ¤í¬
task testBootRepository {
    group = 'nexus'
    description = 'Boot Repository ì—°ê²° ë° ìƒíƒœ í…ŒìŠ¤íŠ¸'
    
    doLast {
        def bootRepoUrl = "${nexusUrl}/${nexusBootRepo}"
        println "Testing Boot Repository: ${bootRepoUrl}"
        
        try {
            def connection = new URL(bootRepoUrl).openConnection()
            connection.setConnectTimeout(5000)
            connection.setReadTimeout(5000)
            
            def username = project.findProperty('nexusUsername') ?: System.getenv('NEXUS_USERNAME')
            def password = project.findProperty('nexusPassword') ?: System.getenv('NEXUS_PASSWORD')
            
            if (username && password) {
                def auth = "${username}:${password}".bytes.encodeBase64().toString()
                connection.setRequestProperty("Authorization", "Basic ${auth}")
            }
            
            def responseCode = connection.getResponseCode()
            println "âœ“ Boot Repository connection successful: HTTP ${responseCode}"
            
            if (responseCode == 200) {
                println "âœ“ Boot Repository is ready for dependency downloads"
            }
        } catch (Exception e) {
            println "âœ— Boot Repository connection failed: ${e.message}"
        }
    }
}

// ë¼ì´ë¸ŒëŸ¬ë¦¬ ìºì‹œ ì •ë¦¬ íƒœìŠ¤í¬
task clearNexusCache {
    group = 'nexus'
    description = 'Nexus Repository ìºì‹œ ì •ë¦¬'
    
    doLast {
        delete "${gradle.gradleUserHomeDir}/caches"
        println "Nexus cache cleared successfully"
    }
}

// Boot Repository ì „ìš© ë¹Œë“œ íƒœìŠ¤í¬
task buildWithBootRepo {
    group = 'nexus'
    description = 'Boot Repositoryë§Œ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ (ì—°ë™ í…ŒìŠ¤íŠ¸ìš©)'
    
    doLast {
        configurations.compileClasspath.files.each { file ->
            if (file.name.endsWith('.jar')) {
                println "Boot Repositoryì—ì„œ ë‹¤ìš´ë¡œë“œ: ${file.name}"
            }
        }
    }
}

// Boot Repository ì˜ì¡´ì„± í™•ì¸
task checkBootDependencies {
    group = 'nexus'
    description = 'Boot Repositoryì—ì„œ ë‹¤ìš´ë¡œë“œëœ ì˜ì¡´ì„± í™•ì¸'
    
    doLast {
        println "\n=== Boot Repository ì˜ì¡´ì„± í™•ì¸ ==="
        def bootDependencies = []
        
        configurations.compileClasspath.resolvedConfiguration.resolvedArtifacts.each { artifact ->
            def id = artifact.moduleVersion.id
            println "âœ“ ${id.group}:${id.name}:${id.version}"
            bootDependencies.add("${id.group}:${id.name}:${id.version}")
        }
        
        println "\nì´ ${bootDependencies.size()}ê°œì˜ ì˜ì¡´ì„±ì´ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."
        
        if (bootDependencies.size() > 0) {
            println "\nğŸ‰ Boot Repository ì—°ë™ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤!"
        }
    }
}

// í™˜ê²½ë³„ ë¹Œë“œ íƒœìŠ¤í¬
task buildDev {
    group = 'nexus'
    description = 'ê°œë°œ í™˜ê²½ìš© ë¹Œë“œ (dev Nexus ì‚¬ìš©)'
    dependsOn 'build'
    
    doFirst {
        project.ext.set('gradle.properties.file', 'gradle-dev.properties')
    }
}

task buildProd {
    group = 'nexus'
    description = 'ìš´ì˜ í™˜ê²½ìš© ë¹Œë“œ (prod Nexus ì‚¬ìš©)'
    dependsOn 'build'
    
    doFirst {
        project.ext.set('gradle.properties.file', 'gradle-prod.properties')
    }
}

